local twilio = require 'twilio'

local MESSAGE_DEFAULT = 'There is something wrong with the furnace.'

local MESSAGES = {
	['low'] = 'The furnace flame is low.',
	['high'] = 'The furnace flame is high.',
	['frozen'] = 'The furnace feed is frozen.',
}

if twilio.verify(request, storage.auth_token) then
	local twiml = '<?xml version="1.0" encoding="UTF-8"?><Response>'

	twiml = twiml..'<Say voice="woman">'
	
	if storage.debug then
		twiml = twiml..'This is a test.'
	end

	if MESSAGES[request.query.msg] then
		twiml = twiml..MESSAGES[request.query.msg]
	else
		twiml = twiml..MESSAGE_DEFAULT
	end

	twiml = twiml..' Connecting with other participants.'

	twiml = twiml..'</Say><Dial><Conference>queenbee</Conference></Dial></Response>'

	return twiml, {['Content-Type']='application/xml'}
else
	return 403
end
